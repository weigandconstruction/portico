# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

Portico is an Elixir library for generating API clients from OpenAPI 3.0 specifications. It parses OpenAPI specs (JSON format) and generates structured Elixir modules with HTTP client functions.

**Note:** Ecto is an optional dependency, only required when generating models (which is the default behavior). If you use `--no-models` flag, Ecto is not needed.

## Core Architecture

- **Portico**: Main entry point that parses specs from URLs or files using `Req` for HTTP requests
- **Portico.Spec**: Core data structures representing OpenAPI specs with typed structs for specs, paths, operations, parameters, and responses
- **Portico.Spec.Schema**: Schema parsing module that extracts both component schemas and inline schemas from operations
- **Mix.Tasks.Portico.Generate**: Mix task that generates API client code from specs
- **Portico.ModelHelpers**: Helper functions for generating Elixir structs from OpenAPI schemas
- **Portico.EctoHelpers**: Converts OpenAPI schemas to Ecto field types and manages embedded schema detection
- **Portico.Runtime.ModelHelpers**: Centralized runtime helpers for generated models (JSON conversion, serialization)
- **Templates**: EEx templates in `priv/templates/` for generating client, API, and model modules

The generation flow: OpenAPI JSON → parsed into Portico.Spec structs → processed through EEx templates → generated Elixir client modules with Ecto-based models.

## Common Commands

```bash
# Install dependencies
mix deps.get

# Compile the project
mix compile

# Run tests
mix test

# Generate configuration file from OpenAPI spec
mix portico.config --spec https://api.example.com/openapi.json
mix portico.config --spec path/to/spec.json --output my-config.json

# Generate API client from OpenAPI spec (includes models by default)
mix portico.generate --module MyAPI --spec https://api.example.com/openapi.json
mix portico.generate --module MyAPI --spec path/to/spec.json

# Generate API client with tag filtering
mix portico.generate --module MyAPI --spec spec.json --tag users
mix portico.generate --module MyAPI --spec spec.json --config my-config.json

# Generate API client without models
mix portico.generate --config my-config.json --no-models

# Run specific test file
mix test test/portico_test.exs

# Interactive shell with project loaded
iex -S mix
```

## Code Generation

Generated clients include:

- Base client module with HTTP configuration (`Client` module)
- API modules for each path with HTTP methods as functions
- Model modules for schemas (structs with typespecs and JSON conversion) - generated by default
- Automatic parameter handling (path, query, header parameters)
- Integration with `Req` HTTP client

### Model Generation

Models are automatically generated from OpenAPI schemas by default using Ecto embedded schemas:

- **Requires Ecto dependency** (`{:ecto, "~> 3.11"}`)
- Located in `lib/your_api/models/` directory
- Use Ecto embedded schemas for type casting without database persistence
- Provide typespecs for all fields (supporting nullability)
- Include `from_json/1` and `to_json/1` conversion functions
- Automatic type casting for dates, datetimes, decimals, and other types
- Support both component schemas and inline schemas in responses
- Handle field name conversion (camelCase → snake_case)
- Inline objects (without $ref) are treated as `:map` fields for flexibility
- Centralized helper functions prevent code duplication across models

To skip model generation (if you don't have Ecto installed), use the `--no-models` flag.

### Usage Example

```elixir
# When generated from a config with base_url:
# Uses default base URL from the OpenAPI spec
client = MyAPI.Client.new()
client = MyAPI.Client.new(auth: {:bearer, "your-token"})

# Override the base URL
client = MyAPI.Client.new(base_url: "https://staging.example.com", auth: {:bearer, "staging-token"})

# When generated without a base_url in config:
# Must provide base_url
client = MyAPI.Client.new(base_url: "https://api.example.com", auth: {:bearer, "your-token"})

# Make API calls (returns {:ok, response} or {:error, exception})
{:ok, users} = MyAPI.Users.list_users(client)
{:ok, post} = MyAPI.Posts.create_post(client, %{title: "Hello", body: "World"})

# With additional options
client = MyAPI.Client.new(
  auth: {:bearer, "token"},
  timeout: 30_000,
  retry: :transient
)
```

### Working with Models

When models are generated (default behavior), API responses are automatically converted to Ecto-powered structs. No manual JSON conversion needed!

```elixir
# API calls automatically return typed model structs
{:ok, %MyAPI.Models.User{} = user} = MyAPI.Users.get_user(client, "123")

# Type casting happens automatically:
# - created_at is a DateTime struct (parsed from ISO 8601 string)
# - age is an integer
# - score is a Decimal
# - is_active is a boolean
# - metadata is a map field (for inline objects without $ref)

# Just use the struct fields directly
IO.puts("User: #{user.name}")
IO.puts("Created: #{user.created_at}")  # DateTime struct, not string!
IO.puts("Active: #{user.is_active}")    # Boolean, not string!

# Arrays are automatically converted too
{:ok, users} = MyAPI.Users.list_users(client)
Enum.each(users, fn %MyAPI.Models.User{} = user ->
  IO.puts("#{user.name}: #{user.email}")
end)

# For requests, just pass regular maps - no conversion needed!
{:ok, updated} = MyAPI.Users.update_user(client, "123", %{
  name: "New Name",
  email: "new@example.com"
})

# Pattern match on typed struct fields
case MyAPI.Users.get_user(client, user_id) do
  {:ok, %MyAPI.Models.User{status: "active", created_at: created} = user} 
    when created > ~U[2024-01-01 00:00:00Z] ->
    # Handle recently created active user
  {:ok, %MyAPI.Models.User{status: "inactive"}} ->
    # Handle inactive user
  {:error, error} ->
    # Handle error
end

# Manual conversion functions exist but are rarely needed:
# MyAPI.Models.User.from_json(json_map)  # JSON map to struct
# MyAPI.Models.User.to_json(user)        # Struct to JSON map
```

## Workflow Reminders

- When done making changes, run tests to confirm everything is working
- Don't forget to run `mix format` after finishing code generation
- Don't forget to run `mix credo` after finishing code generation and fix any issues
